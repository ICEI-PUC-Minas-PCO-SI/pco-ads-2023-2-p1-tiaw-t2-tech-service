let params = new URLSearchParams(location.search);
let id = params.get("id");

let responseData = [];
fetch(`http://localhost:3000/usuarios/${id}`, {
  method: "GET",
  headers: {
    "Content-Type": "applicaton/json",
  },
})
  .then((response) => {
    if (!response.ok) {
      throw new Error("Erro requisação");
    }
    return response.json();
  })
  .then((data) => {
    passarDados(data);
  })
  .catch((erro) => {
    console.error("Error na requisição", erro.message);
  }),
  console.log(responseData);
function passarDados(dados) {
  responseData.push(dados);
}

console.log(responseData);
$(document).ready(function () {
  //Recuperando ID do usuario
  let linkPerfil = document.getElementById("a-Perfil");
  let linkCarrosel = document.getElementById("a-carrossel");
  let linkCriar = document.getElementById("a-CriarVaga");
  let linkForum = document.getElementById("a-Forum");
  linkForum.href = `Forum.html?id=${id}`;
  linkPerfil.href = `Perfil.Freelancer.html?id=${id}`;
  linkCarrosel.href = `carrossel.html?id=${id}`;
  linkCriar.href = `TelaCriarVagas.html?id=${id}`;

  //Recuperando ID do usuario
  let usuario = [
    {
      id: 0,
      login: "",
      senha: "",
      nome: "",
      sobre: "",
      curriculo: "",
      portfolio: "",
      imagem: "",
      servicos: [],
      Vaga: [],
    },
  ];

  $("#submit-usuario").click(function () {
    let nome = $("#input-nome").val();
    let sobre = $("#textarea-sobre").val();
    let curriculo = $("#input-arquivo1").val();
    let portfolio = $("#input-arquivo2").val();
    let imagem = $("#input-img").val();
    do {
      if (nome === "") {
        $("#input-nome").css({
          border: "4px solid red",
        });
        $("#meuModal-Servico").modal("show");
        $(".modal-title-serv").css("color", "red").text("Aviso!!");
        $("#paragraph-modal-serv")
          .css({ color: "red", "font-size": "1.5rem" })
          .text("Insira o nome (OBRIGATÓRIO)");
        break;
      } else {
        $("#input-nome").css({
          border: "4px solid green",
          color: "green",
        });
      }
    } while (nome === "");
    setTimeout(function () {
      $("#input-nome").css({
        border: "",
        color: "",
      });
    }, 3000);

    if (sobre === "") {
      $("#textarea-sobre").css({
        border: "4px solid red",
        color: "red",
      });
    } else {
      $("#textarea-sobre").css({
        border: "4px solid green",
        color: "green",
      });
    }
    setTimeout(function () {
      $("#textarea-sobre").css({
        border: "",
        color: "",
      });
    }, 3000);

    if (curriculo === "") {
      $("#input-arquivo1").css({
        border: "4px solid red",
        color: "red",
      });
    } else {
      $("#input-arquivo1").css({
        border: "4px solid green",
        color: "green",
      });
    }
    setTimeout(function () {
      $("#input-arquivo1").css({
        border: "",
        color: "",
      });
    }, 3000);

    if (portfolio === "") {
      $("#input-arquivo2").css({
        border: "4px solid red",
        color: "red",
      });
    } else {
      $("#input-arquivo2").css({
        border: "4px solid green",
        color: "green",
      });
    }
    setTimeout(function () {
      $("#input-arquivo2").css({
        border: "",
        color: "",
      });
    }, 3000);

    if (imagem === "") {
      $("#input-img").css({
        border: "4px solid red",
        color: "red",
      });
    } else {
      $("#input-img").css({
        border: "4px solid green",
        color: "green",
      });
    }
    setTimeout(function () {
      $("#input-img").css({
        border: "",
        color: "",
      });
    }, 3000);
    let temPropriedadeVazia = false;
    if (nome !== "") {
      usuario[0].nome = nome;
      usuario[0].sobre = sobre;
      usuario[0].portfolio = portfolio;
      usuario[0].imagem = imagem;
      usuario[0].curriculo = curriculo;

      if (!nome || !sobre || !portfolio || !imagem || !curriculo) {
        temPropriedadeVazia = true;
      }

      if (temPropriedadeVazia) {
        $("#meuModal").modal("show");
        $("#paragraph-modal").text(
          "Alguns dados ainda não foram preenchidos. Deseja salvar mesmo assim?"
        );
      } else {
        $("#meuModal").modal("show");
        $("#paragraph-modal").text(
          "Todos os dados foram preenchidos. Deseja salvá-los?"
        );
      }
    }
  });

  $("#btn-seguir").click(function (ev) {
    ev.preventDefault();
    fetch(`http://localhost:3000/usuarios/${id}`);
    let user = {
      id: id,
      login: responseData[0].login,
      senha: responseData[0].senha,
      nome: usuario[0].nome,
      sobre: usuario[0].sobre,
      portfolio: usuario[0].portfolio,
      curriculo: usuario[0].curriculo,
      imagem: usuario[0].imagem,
      servicos: "",
      Vaga: "",
    };
    console.log(user);
    URL = `http://localhost:3000/usuarios/${id}`;
    fetch(URL, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(user),
    });
    setTimeout(function () {
      $("#meuModal").modal("hide");
    }, 5000);
    if (user.imagem == "") {
      $("#img-usuario").attr("src", "/src/imgs/avatarimg.png");
      alert("Problema");
    } else {
      alert("Entrei");
      alert("URL" + user.imagem);
      let img = document.getElementById("img-user");
      img.src = user.imagem;
      getServ();
    }

    $("input[type='text']").val("");
    $("input[type='text'], textarea").val("");
  });

  $("#input-serv").click(function (e) {
    e.preventDefault();
    let novoTitulo = $("#titulo-serv").val();
    let novaDescricao = $("#descricao-serv").val();

    //GET fect
    fetch("http://localhost:3000/servicos")
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        if (novoTitulo == "" || novaDescricao == "") {
          $("#meuModal-Servico").modal("show");
          $(".modal-title-serv").css("color", "red").text("Aviso!!");
          $("#paragraph-modal-serv")
            .css({ color: "red", "font-size": "1.5rem" })
            .text("Insira todos os dados");
        } else {
          if (data) {
            let servic = {
              id: id,
              title: novoTitulo,
              descricao: novaDescricao,
            };
            // usuario.servicos.push({
            //   titulo: novoTitulo,
            //   descricao: novaDescricao,
            // });

            newVaga(servic);
            getServ();

            $("#meuModal-Servico").modal("show");
            $(".modal-title-serv").css("color", "green").text("Sucesso");
            $("#paragraph-modal-serv")
              .css({ color: "green", "font-size": "1rem" })
              .text("Enviado ");

            setTimeout(function () {
              $(".dados-servicos input[type= 'text'], textarea").val("");
            }, 3000);
          } else {
            $("#meuModal-Servico").modal("show");
            $(".modal-title-serv").css("color", "red").text("Aviso!!");
            $("#paragraph-modal-serv")
              .css("color", "red")
              .text("Você execedeu a quantidade maxima de Serviços (4) ");
          }
          localStorage.setItem("usuario", JSON.stringify(usuario));
        }
      });
  });
});
function newVaga(dados) {
  console.log(dados);
  console.log(id);
  fetch(`http://localhost:3000/servicos/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(dados),
  })
    .then((response) => response.json())
    .then((data) => {
      console.log(data);
      getServ();
    });
}

function getServ(event) {
  event.preventDefault();
  alert("Trava");
  URL = `http://localhost:3000/servicos/${id}`;
  console.log("entrei");

  fetch(URL)
    .then(function (response) {
      return response.json();
    })
    .then(function (data) {
      if (data.title && data.descricao) {
        console.log(usuario[0].imagem);
        let recData = "";
        let divSectio = document.querySelector(".section-editarPerfil");
        recData = `
         <div class="div-servic">
          <div class="div-img">
           <img src="${usuario[0].imagem}" alt="Minha Figura">
          </div>
          <div class="div-text">
            <p class="p-title">${data.title}</p>
            <p class="p-title">${data.descricao}</p>
          </div>
          <button id="remove-${id}" name="button">Remover</button>
         </div
         `;
        divSectio.append(recData);
      }
    });
}
